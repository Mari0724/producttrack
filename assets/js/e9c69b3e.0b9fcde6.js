"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1195],{8453:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>a});var i=s(6540);const r={},c=i.createContext(r);function d(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),i.createElement(c.Provider,{value:n},e.children)}},8972:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>a,default:()=>u,frontMatter:()=>d,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"backend/services/nutriscan.service","title":"Servicio NutriScan","description":"Este servicio centraliza toda la l\xf3gica de negocio relacionada con el m\xf3dulo NutriScan, incluyendo creaci\xf3n, consulta, actualizaci\xf3n y eliminaci\xf3n de an\xe1lisis nutricionales generados por usuarios mediante OCR y consultas autom\xe1ticas a OpenFoodFacts, con generaci\xf3n de mensajes usando GPT.","source":"@site/docs/backend/services/nutriscan.service.md","sourceDirName":"backend/services","slug":"/backend/services/nutriscan.service","permalink":"/producttrack/docs/backend/services/nutriscan.service","draft":false,"unlisted":false,"editUrl":"https://github.com/Mari0724/producttrack/docs/backend/services/nutriscan.service.md","tags":[],"version":"current","frontMatter":{"id":"nutriscan.service","title":"Servicio NutriScan","sidebar_label":"NutriScan"},"sidebar":"tutorialSidebar","previous":{"title":"Log Service","permalink":"/producttrack/docs/backend/services/log.service"},"next":{"title":"OpenFoodFacts","permalink":"/producttrack/docs/backend/services/openfoodfacts.service"}}');var r=s(4848),c=s(8453);const d={id:"nutriscan.service",title:"Servicio NutriScan",sidebar_label:"NutriScan"},a="NutriScan",t={},o=[{value:"\ud83d\udd0d Ubicaci\xf3n",id:"-ubicaci\xf3n",level:2},{value:"\ud83d\udccc Prop\xf3sito",id:"-prop\xf3sito",level:2},{value:"\ud83e\udde9 Importaciones clave",id:"-importaciones-clave",level:2},{value:"\ud83e\udde0 Clase: <code>NutriScanService</code>",id:"-clase-nutriscanservice",level:2},{value:"\u2705 <code>create(data, usuarioId, isTest)</code>",id:"-createdata-usuarioid-istest",level:3},{value:"\ud83d\udcc4 <code>findAll()</code>",id:"-findall",level:3},{value:"\ud83e\uddea <code>findTestsByUser(usuarioId)</code>",id:"-findtestsbyuserusuarioid",level:3},{value:"\ud83d\udd0d <code>findByUserId(usuarioId)</code>",id:"-findbyuseridusuarioid",level:3},{value:"\u270f\ufe0f <code>update(id, data)</code>",id:"\ufe0f-updateid-data",level:3},{value:"\ud83d\uddd1\ufe0f <code>delete(id)</code>",id:"\ufe0f-deleteid",level:3},{value:"\ud83d\udcdd Esquemas utilizados",id:"-esquemas-utilizados",level:2},{value:"Esquema de creaci\xf3n (<code>NutriScanSchemaWithoutUserId</code>)",id:"esquema-de-creaci\xf3n-nutriscanschemawithoutuserid",level:3},{value:"Esquema de actualizaci\xf3n (<code>NutriScanUpdateSchema</code>)",id:"esquema-de-actualizaci\xf3n-nutriscanupdateschema",level:3},{value:"\ud83d\udd04 Flujo t\xedpico de <code>create()</code>",id:"-flujo-t\xedpico-de-create",level:2},{value:"\u2705 Validaciones y control de errores",id:"-validaciones-y-control-de-errores",level:2},{value:"\ud83e\uddfe Resumen",id:"-resumen",level:2}];function l(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"nutriscan",children:"NutriScan"})}),"\n",(0,r.jsxs)(n.p,{children:["Este servicio centraliza toda la ",(0,r.jsx)(n.strong,{children:"l\xf3gica de negocio"})," relacionada con el m\xf3dulo ",(0,r.jsx)(n.strong,{children:"NutriScan"}),", incluyendo creaci\xf3n, consulta, actualizaci\xf3n y eliminaci\xf3n de an\xe1lisis nutricionales generados por usuarios mediante OCR y consultas autom\xe1ticas a OpenFoodFacts, con generaci\xf3n de mensajes usando GPT."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-ubicaci\xf3n",children:"\ud83d\udd0d Ubicaci\xf3n"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"src/services/nutriscan.service.ts"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-prop\xf3sito",children:"\ud83d\udccc Prop\xf3sito"}),"\n",(0,r.jsx)(n.p,{children:"Gestionar el flujo completo de an\xe1lisis nutricional desde la recepci\xf3n de datos hasta su persistencia en base de datos, incluyendo validaci\xf3n, enriquecimiento con fuentes externas y control de acceso."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-importaciones-clave",children:"\ud83e\udde9 Importaciones clave"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'import prisma from "../utils/prismaClient";\r\nimport { NutriScanSchemaWithoutUserId, NutriScanUpdateSchema } from "../models/NutriScanModel";\r\nimport { OpenFoodFactsService } from "./openfoodfacts.service";\r\nimport { gptService } from "./gpt.service";\n'})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"M\xf3dulo"}),(0,r.jsx)(n.th,{children:"Prop\xf3sito"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"prismaClient"})}),(0,r.jsx)(n.td,{children:"ORM para acceso a la base de datos."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"NutriScanSchema..."})}),(0,r.jsx)(n.td,{children:"Validaciones con Zod para entrada y actualizaci\xf3n."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"OpenFoodFactsService"})}),(0,r.jsx)(n.td,{children:"Consulta informaci\xf3n nutricional abierta por nombre."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"gptService"})}),(0,r.jsx)(n.td,{children:"Genera un resumen nutricional con OpenAI GPT."})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"-clase-nutriscanservice",children:["\ud83e\udde0 Clase: ",(0,r.jsx)(n.code,{children:"NutriScanService"})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"-createdata-usuarioid-istest",children:["\u2705 ",(0,r.jsx)(n.code,{children:"create(data, usuarioId, isTest)"})]}),"\n",(0,r.jsx)(n.p,{children:"Crea un nuevo an\xe1lisis autom\xe1tico. El flujo:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Valida los datos con ",(0,r.jsx)(n.code,{children:"Zod"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Consulta OpenFoodFacts con el nombre del producto."}),"\n",(0,r.jsxs)(n.li,{children:["Genera un mensaje nutricional con ",(0,r.jsx)(n.code,{children:"GPT"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Guarda el resultado en la base de datos con marca de prueba (",(0,r.jsx)(n.code,{children:"isTest"}),") si aplica."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const parsed = NutriScanSchemaWithoutUserId.parse(data);\r\nconst resultados = await OpenFoodFactsService.buscarAlimentoPorNombre(nombreProducto);\r\nconst mensaje = await gptService.generarMensajeNutricional(...);\r\nawait prisma.nutriScan.create(...);\n"})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Par\xe1metro"}),(0,r.jsx)(n.th,{children:"Tipo"}),(0,r.jsx)(n.th,{children:"Descripci\xf3n"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"data"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"unknown"})}),(0,r.jsx)(n.td,{children:"Datos de entrada (consulta, esAlimento, etc.)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"usuarioId"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"number"})}),(0,r.jsx)(n.td,{children:"ID del usuario que env\xeda el an\xe1lisis"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"isTest"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"boolean"})}),(0,r.jsx)(n.td,{children:"Si el an\xe1lisis es de prueba (modo desarrollador)"})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"-findall",children:["\ud83d\udcc4 ",(0,r.jsx)(n.code,{children:"findAll()"})]}),"\n",(0,r.jsx)(n.p,{children:"Devuelve todos los an\xe1lisis registrados en la base de datos.\r\nIncluye datos del usuario que los cre\xf3 (nombre y tipo)."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'return prisma.nutriScan.findMany({\r\n  orderBy: { fechaAnalisis: "desc" },\r\n  include: {\r\n    usuario: {\r\n      select: {\r\n        nombreCompleto: true,\r\n        tipoUsuario: true,\r\n      },\r\n    },\r\n  },\r\n});\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"-findtestsbyuserusuarioid",children:["\ud83e\uddea ",(0,r.jsx)(n.code,{children:"findTestsByUser(usuarioId)"})]}),"\n",(0,r.jsx)(n.p,{children:"Retorna \xfanicamente los an\xe1lisis de prueba hechos por un usuario espec\xedfico."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"-findbyuseridusuarioid",children:["\ud83d\udd0d ",(0,r.jsx)(n.code,{children:"findByUserId(usuarioId)"})]}),"\n",(0,r.jsx)(n.p,{children:"Obtiene todos los an\xe1lisis (de prueba o reales) realizados por un usuario determinado.\r\nIncluye detalles del usuario y se ordena por fecha descendente."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"\ufe0f-updateid-data",children:["\u270f\ufe0f ",(0,r.jsx)(n.code,{children:"update(id, data)"})]}),"\n",(0,r.jsxs)(n.p,{children:["Actualiza un an\xe1lisis nutricional existente, validando solo los campos enviados con ",(0,r.jsx)(n.code,{children:"NutriScanUpdateSchema"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const parsed = NutriScanUpdateSchema.parse(data);\r\nawait prisma.nutriScan.update({ where: { id }, data: parsed });\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["Soporta actualizaciones parciales como ",(0,r.jsx)(n.code,{children:"consulta"}),", ",(0,r.jsx)(n.code,{children:"tipoAnalisis"}),", ",(0,r.jsx)(n.code,{children:"esAlimento"}),", ",(0,r.jsx)(n.code,{children:"respuesta"}),", etc."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"\ufe0f-deleteid",children:["\ud83d\uddd1\ufe0f ",(0,r.jsx)(n.code,{children:"delete(id)"})]}),"\n",(0,r.jsx)(n.p,{children:"Elimina un an\xe1lisis de la base de datos permanentemente.\r\nDevuelve un mensaje de confirmaci\xf3n."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-esquemas-utilizados",children:"\ud83d\udcdd Esquemas utilizados"}),"\n",(0,r.jsxs)(n.h3,{id:"esquema-de-creaci\xf3n-nutriscanschemawithoutuserid",children:["Esquema de creaci\xf3n (",(0,r.jsx)(n.code,{children:"NutriScanSchemaWithoutUserId"}),")"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'{\r\n  esAlimento: boolean;\r\n  consulta: string;\r\n  tipoAnalisis: "ocr-gpt-only" | "ocr-openfoodfacts-gpt";\r\n}\n'})}),"\n",(0,r.jsxs)(n.h3,{id:"esquema-de-actualizaci\xf3n-nutriscanupdateschema",children:["Esquema de actualizaci\xf3n (",(0,r.jsx)(n.code,{children:"NutriScanUpdateSchema"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"Permite modificar selectivamente:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'{\r\n  consulta?: string;\r\n  esAlimento?: boolean;\r\n  tipoAnalisis?: "ocr-gpt-only" | "ocr-openfoodfacts-gpt";\r\n  isTest?: boolean;\r\n  respuesta?: {\r\n    mensaje: string;\r\n    generadoPor: string;\r\n  };\r\n}\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"-flujo-t\xedpico-de-create",children:["\ud83d\udd04 Flujo t\xedpico de ",(0,r.jsx)(n.code,{children:"create()"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-txt",children:"Frontend \u2192 texto OCR \u2192 NutriScanService.create()\r\n                 \u21b3 OpenFoodFacts (buscar alimento)\r\n                 \u21b3 GPT (crear resumen)\r\n                 \u21b3 Guardar en BD (Prisma)\r\n                 \u21b3 Retornar an\xe1lisis generado\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-validaciones-y-control-de-errores",children:"\u2705 Validaciones y control de errores"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Validaci\xf3n estricta con ",(0,r.jsx)(n.code,{children:"Zod"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Captura de errores y trazabilidad en consola."}),"\n",(0,r.jsxs)(n.li,{children:["Soporte para ejecuci\xf3n en modo de prueba (",(0,r.jsx)(n.code,{children:"isTest"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Inclusi\xf3n de informaci\xf3n del usuario (para auditor\xeda o frontend)."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-resumen",children:"\ud83e\uddfe Resumen"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Funci\xf3n principal"}),(0,r.jsx)(n.th,{children:"Crear y administrar an\xe1lisis nutricionales"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Base de datos"}),(0,r.jsx)(n.td,{children:"Prisma ORM"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Integraciones"}),(0,r.jsx)(n.td,{children:"OpenFoodFacts, GPT"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Validaci\xf3n"}),(0,r.jsxs)(n.td,{children:["Zod (",(0,r.jsx)(n.code,{children:"NutriScanSchemaWithoutUserId"}),", ",(0,r.jsx)(n.code,{children:"NutriScanUpdateSchema"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Modos soportados"}),(0,r.jsxs)(n.td,{children:["Normal y prueba (",(0,r.jsx)(n.code,{children:"isTest"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"M\xe9todos clave"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"create"}),", ",(0,r.jsx)(n.code,{children:"findAll"}),", ",(0,r.jsx)(n.code,{children:"findByUserId"}),", ",(0,r.jsx)(n.code,{children:"update"}),", ",(0,r.jsx)(n.code,{children:"delete"})]})]})]})]})]})}function u(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}}}]);