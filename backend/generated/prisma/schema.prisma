// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  idUsuario      Int    @id @default(autoincrement())
  username       String @unique
  correo         String @unique
  password       String
  nombreCompleto String
  telefono       String
  direccion      String
  fotoPerfil     String

  // Campos opcionales porque solo aplican a EMPRESARIAL
  nombreEmpresa String?
  nit           String? @unique
  estado        String
  rol           String

  // Nuevo campo obligatorio para diferenciar usuarios
  tipoUsuario TipoUsuario
  rolEquipo   rolEquipo?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?

  auteRest         auteRest?
  notificaciones   notificaciones[]
  productos        productos[]
  comentarios      comentarios[]
  soporte          soporte[]
  ajustInven       ajustInven[]
  analisisImagenes analisisImagenes[]
  histInv          histInv[]
  api_logs         api_logs[]
  MonAudRend       MonAudRend[]
  auditoria        auditoria[]
}

enum TipoUsuario {
  INDIVIDUAL
  EMPRESARIAL
}

enum rol {
  USUARIO // individual o empresa
  EQUIPO // miembro del equipo de una empresa
  ADMIN // administrador del sistema
  DESARROLLADOR
}

enum rolEquipo {
  LECTOR
  COMENTARISTA
  EDITOR
  ADMIN // de la empresa
}

model auteRest {
  idSeguridad     Int      @id @default(autoincrement())
  idUsuario       Int      @unique
  googleId        String   @unique
  token           String
  fechaSolicitud  DateTime
  fechaExpiracion DateTime
  usado           Boolean
  confirmado      Boolean
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user users @relation(fields: [idUsuario], references: [idUsuario])
}

model notificaciones {
  idNotificacion Int              @id @default(autoincrement())
  idUsuario      Int
  tipo           TipoNotificacion
  titulo         String
  mensaje        String
  fechaEnvio     DateTime
  leida          Boolean

  user users @relation(fields: [idUsuario], references: [idUsuario])
}

enum TipoNotificacion {
  general
  solicitud
  recomendacion
}

model productos {
  id               Int       @id @default(autoincrement())
  codigoBarras     String    @unique
  codigoQR         String    @unique
  nombre           String
  descripcion      String
  categoriaId      Int
  cantidad         Int
  precio           Decimal
  fechaAdquisicion DateTime
  fechaVencimiento DateTime
  usuarioId        Int
  estado           String
  imagen           String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  eliminadoEn      DateTime?

  usuario        users            @relation(fields: [usuarioId], references: [idUsuario])
  histoVenta     histoVenta[]
  recorStock     recorStock[]
  alertVen       alertVen[]
  colaboraciones colaboraciones[]
  ajustInven     ajustInven[]
  histInv        histInv[]
}

model histoVenta {
  idVenta         Int      @id @default(autoincrement())
  idProducto      Int
  cantidadVendida Int
  fechaVenta      DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  producto productos @relation(fields: [idProducto], references: [id])
}

model recorStock {
  idRecordatorio    Int                @id @default(autoincrement())
  idProducto        Int
  cantidadMinima    Int
  fechaRecordatorio DateTime
  estado            EstadoRecordatorio
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  producto productos @relation(fields: [idProducto], references: [id])
}

enum EstadoRecordatorio {
  pendiente
  atendido
}

model comentarios {
  idComentario    Int              @id @default(autoincrement())
  idUsuario       Int
  comentario      String
  fechaComentario DateTime
  estado          EstadoComentario
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  user users @relation(fields: [idUsuario], references: [idUsuario])
}

enum EstadoComentario {
  pendiente
  revisado
}

model soporte {
  idSoporte   Int           @id @default(autoincrement())
  idUsuario   Int
  asunto      String
  descripcion String
  estado      EstadoSoporte
  respuesta   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user users @relation(fields: [idUsuario], references: [idUsuario])
}

enum EstadoSoporte {
  pendiente
  en_proceso
  resuelto
}

model ajustInven {
  idAjuste         Int      @id @default(autoincrement())
  idProducto       Int
  idUsuario        Int
  cantidadAnterior Int
  cantidadNueva    Int
  motivo           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  producto productos @relation(fields: [idProducto], references: [id])
  usuario  users     @relation(fields: [idUsuario], references: [idUsuario])
}

model alertVen {
  idAlerta    Int                @id @default(autoincrement())
  idProducto  Int
  fechaAlerta DateTime
  estado      EstadoRecordatorio
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  producto productos @relation(fields: [idProducto], references: [id])
}

model analisisImagenes {
  id            Int      @id @default(autoincrement())
  usuarioId     Int
  esAlimento    Boolean
  consulta      String
  respuesta     Json
  fechaAnalisis DateTime

  usuario users @relation(fields: [usuarioId], references: [idUsuario])
}

model colaboraciones {
  id          Int      @id @default(autoincrement())
  productoId  Int
  marca       String
  tarifa      Decimal
  fechaInicio DateTime
  fechaFin    DateTime

  producto productos @relation(fields: [productoId], references: [id])
}

model histInv {
  id                Int             @id @default(autoincrement())
  productoId        Int
  usuarioId         Int
  accion            AccionHistorial
  cantidad_anterior Int
  cantidad_nueva    Int
  precio_anterior   Decimal
  precio_nuevo      Decimal
  fechaCambio       DateTime

  producto productos @relation(fields: [productoId], references: [id])
  usuario  users     @relation(fields: [usuarioId], references: [idUsuario])
}

enum AccionHistorial {
  agregado
  modificado
  eliminado
}

model api_logs {
  id              Int       @id @default(autoincrement())
  endpoint        String
  metodo          MetodoAPI
  statusCode      Int
  tiempoRespuesta Decimal
  fecha           DateTime
  errorMensaje    String
  usuarioId       Int

  usuario users @relation(fields: [usuarioId], references: [idUsuario])
}

enum MetodoAPI {
  GET
  POST
  PUT
  DELETE
}

model MonAudRend {
  id           Int        @id @default(autoincrement())
  tipoEvento   TipoEvento
  nombreEvento String
  descripcion  String
  usuarioId    Int
  fecha        DateTime
  ip_address   String
  nivel        String
  valor        Decimal
  stackTrace   String

  usuario users @relation(fields: [usuarioId], references: [idUsuario])
}

enum TipoEvento {
  evento
  error
  metrica
}

model auditoria {
  id          Int      @id @default(autoincrement())
  evento      String
  usuarioId   Int
  descripcion String
  fecha       DateTime

  usuario users @relation(fields: [usuarioId], references: [idUsuario])
}
